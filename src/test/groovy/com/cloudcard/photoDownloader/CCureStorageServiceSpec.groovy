package com.cloudcard.photoDownloader;

import spock.lang.*

class TouchNetStorageServiceSpec extends Specification{

    TouchNetStorageService service = new TouchNetStorageService()

    String sessionId = "asdf"
    String base64Photo = "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";

    void setup() {
        service.touchNetClient = Mock(TouchNetClient)
        service.fileNameResolver = Mock(FileNameResolver)
    }

    void "test save with no photos"() {
        given:
        List<Photo> photos = [];

        when:
        List<PhotoFile> photoFiles = service.save(photos);

        then:
        photoFiles.size() == 0;

        0 * service.touchNetClient._
    }

    void "test save with one good photo"() {
        given:
        String identifier = "100012345"
        Photo photo = new Photo(
                id: 1,
                person: new Person(identifier: identifier, email: "$identifier@bacon.edu"),
                bytes: Base64.decoder.decode(base64Photo)
        )
        List<Photo> photos = [ photo ]

        when:
        List<PhotoFile> photoFiles = service.save(photos)

        then:
        photoFiles.size() == 1
        assert photoFiles[0]
        photoFiles[0].baseName == identifier
        photoFiles[0].photoId == 1

        1 * service.touchNetClient.operatorLogin() >> sessionId
        1 * service.fileNameResolver.getBaseName(photo) >> identifier
        1 * service.touchNetClient.accountPhotoApprove(sessionId, identifier, base64Photo) >> true
        1 * service.touchNetClient.operatorLogout(sessionId) >> true
    }

    void "test save with three good photos"() {
        given:
        List<String> identifiers = ["100012345", "100012346", "100012347"]
        List<Photo> photos = identifiers.withIndex().collect { it, index ->
            new Photo(
                    id: index,
                    person: new Person(identifier: it, email: "$it@bacon.edu"),
                    bytes: [0,1,2,3,index] as byte[]
            )
        }

        when:
        List<PhotoFile> photoFiles = service.save(photos)

        then:
        photoFiles.size() == 3
        photoFiles.eachWithIndex { it, index ->
            assert it
            assert it.photoId == index
            assert it.baseName == identifiers[index]
        }

        1 * service.touchNetClient.operatorLogin() >> sessionId
        1 * service.fileNameResolver.getBaseName(photos[0]) >> identifiers[0]
        1 * service.fileNameResolver.getBaseName(photos[1]) >> identifiers[1]
        1 * service.fileNameResolver.getBaseName(photos[2]) >> identifiers[2]
        1 * service.touchNetClient.accountPhotoApprove(sessionId, identifiers[0], Base64.encoder.encodeToString([0,1,2,3,0] as byte[])) >> true
        1 * service.touchNetClient.accountPhotoApprove(sessionId, identifiers[1], Base64.encoder.encodeToString([0,1,2,3,1] as byte[])) >> true
        1 * service.touchNetClient.accountPhotoApprove(sessionId, identifiers[2], Base64.encoder.encodeToString([0,1,2,3,2] as byte[])) >> true
        1 * service.touchNetClient.operatorLogout(sessionId) >> true
    }

    void "test save with one failure and two successful photos"() {
        given:
        List<String> identifiers = ["100012345", "bad012346", "100012347"]
        List<Photo> photos = identifiers.withIndex().collect { it, index ->
            new Photo(
                    id: index,
                    person: new Person(identifier: it, email: "$it@bacon.edu"),
                    bytes: [0,1,2,3,index] as byte[]
            )
        }

        when:
        List<PhotoFile> photoFiles = service.save(photos)

        then:
        photoFiles.size() == 3
        photoFiles.eachWithIndex { it, index ->
            if (index == 1) {
                assert !it
            } else {
                assert it
                assert it.photoId == index
                assert it.baseName == identifiers[index]
            }
        }

        1 * service.touchNetClient.operatorLogin() >> sessionId
        1 * service.fileNameResolver.getBaseName(photos[0]) >> identifiers[0]
        1 * service.fileNameResolver.getBaseName(photos[1]) >> identifiers[1]
        1 * service.fileNameResolver.getBaseName(photos[2]) >> identifiers[2]
        1 * service.touchNetClient.accountPhotoApprove(sessionId, identifiers[0], Base64.encoder.encodeToString([0,1,2,3,0] as byte[])) >> true
        1 * service.touchNetClient.accountPhotoApprove(sessionId, identifiers[1], Base64.encoder.encodeToString([0,1,2,3,1] as byte[])) >> false
        1 * service.touchNetClient.accountPhotoApprove(sessionId, identifiers[2], Base64.encoder.encodeToString([0,1,2,3,2] as byte[])) >> true
        1 * service.touchNetClient.operatorLogout(sessionId) >> true
    }

    void "test save when login fails"() {
        given:
        String identifier = "100012345"
        Photo photo = new Photo(
                id: 1,
                person: new Person(identifier: identifier, email: "$identifier@bacon.edu"),
                bytes: Base64.decoder.decode(base64Photo)
        )
        List<Photo> photos = [ photo ]

        when:
        List<PhotoFile> photoFiles = service.save(photos)

        then:
        photoFiles.size() == 0

        1 * service.touchNetClient.operatorLogin() >> null
    }

    void "test save when logout fails"() {
        given:
        String identifier = "100012345"
        Photo photo = new Photo(
                id: 1,
                person: new Person(identifier: identifier, email: "$identifier@bacon.edu"),
                bytes: Base64.decoder.decode(base64Photo)
        )
        List<Photo> photos = [ photo ]


        when:
        List<PhotoFile> photoFiles = service.save(photos)

        then:
        photoFiles.size() == 1
        assert photoFiles[0]
        photoFiles[0].baseName == identifier
        photoFiles[0].photoId == 1

        1 * service.touchNetClient.operatorLogin() >> sessionId
        1 * service.fileNameResolver.getBaseName(photo) >> identifier
        1 * service.touchNetClient.accountPhotoApprove(sessionId, identifier, base64Photo) >> true
        1 * service.touchNetClient.operatorLogout(sessionId) >> false
    }

    void "test save when accountId not resolvable"() {
        given:
        Photo photo = new Photo(
                id: 1,
                person: new Person(identifier: null, email: "null@bacon.edu"),
                bytes: Base64.decoder.decode(base64Photo)
        )

        when:
        PhotoFile photoFile = service.save(photo, sessionId)

        then:
        photoFile == null

        1 * service.fileNameResolver.getBaseName(photo) >> null
        0 * service.touchNetClient.accountPhotoApprove(_,_,_)
    }

    void "test save with photo missing bytes"() {
        given:
        String identifier = "100012345"
        Photo photo = new Photo(
                id: 1,
                person: new Person(identifier: identifier, email: "$identifier@bacon.edu"),
                bytes: null
        )

        when:
        PhotoFile photoFile = service.save(photo, sessionId)

        then:
        photoFile == null

        1 * service.fileNameResolver.getBaseName(photo) >> identifier
        0 * service.touchNetClient.accountPhotoApprove(_,_,_)
    }

    void "test save with photo missing person"() {
        given:
        Photo photo = new Photo(
                id: 1,
                person: null,
                bytes: null
        )

        when:
        PhotoFile photoFile = service.save(photo, sessionId)

        then:
        photoFile == null

        0 * service.fileNameResolver.getBaseName(photo)
        0 * service.touchNetClient.accountPhotoApprove(_,_,_)
    }

}
